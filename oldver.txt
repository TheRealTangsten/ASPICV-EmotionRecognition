import os
import cv as cv  # Replacing cv2 with cv
import numpy as np
from sklearn.model_selection import train_test_split
from sklearn.preprocessing import StandardScaler
from sklearn.neural_network import MLPClassifier
from sklearn.metrics import classification_report, accuracy_score
from skimage.feature import local_binary_pattern

# Parameters for LBP
RADIUS = 1
N_POINTS = 8 * RADIUS
METHOD = 'uniform'

# Classes mapping
EMOTION_MAP = {
    'happy': 'positive',
    'surprise': 'positive',
    'sadness': 'negative',
    'anger': 'negative',
    'fear': 'negative',
    'disgust': 'negative',
    'contempt': 'negative',
}

# Load and preprocess data
def load_ck_plus_data(base_path):
    data = []
    labels = []
    for emotion_folder in os.listdir(base_path):
        emotion_path = os.path.join(base_path, emotion_folder)
        print("\n\n" + emotion_path + " | ")
        if os.path.isdir(emotion_path):
            label = EMOTION_MAP.get(emotion_folder, None)
            print(label)
            if label:
                person_folders = sorted(os.listdir(emotion_path))
                print(person_folders)
                for person_folder in person_folders:
                    person_path = os.path.join(emotion_path, person_folder)
                    print(person_path)
                    if os.path.isdir(person_path):
                        files = sorted(os.listdir(person_path))
                        print(files)
                        if files:
                            # Select only the last image (maximum intensity)
                            img_path = os.path.join(person_path, files[-1])
                            img = cv.imread(img_path, cv.IMREAD_GRAYSCALE)
                            if img is not None:
                                lbp = local_binary_pattern(img, N_POINTS, RADIUS, METHOD)
                                hist, _ = np.histogram(lbp.ravel(), bins=np.arange(0, N_POINTS + 3), density=True)
                                data.append(hist)
                                labels.append(1 if label == 'positive' else 0)
    return np.array(data), np.array(labels)

# Main function
def main():
    # Load data
    base_path = "C:\\Users\\Tangsten\\PycharmProjects\\ASPICV_EmotionRecognition\\Date"  # Update with the actual path to the dataset
    data, labels = load_ck_plus_data(base_path)

    print(data)

    # Normalize features
    scaler = StandardScaler()
    data = scaler.fit_transform(data)

    # Split data
    X_train, X_test, y_train, y_test = train_test_split(data, labels, test_size=0.2, random_state=42)

    # Hyperparameters to test
    hidden_layer_sizes = [50, 500, 5000]
    learning_rates = [0.01, 1, 100]

    # Experimentation
    best_accuracy = 0
    best_model = None
    for h_size in hidden_layer_sizes:
        for lr in learning_rates:
            print(f"Training MLP with hidden_layer_sizes={h_size}, learning_rate={lr}")
            mlp = MLPClassifier(hidden_layer_sizes=(h_size,), learning_rate_init=lr, max_iter=500, random_state=42)
            mlp.fit(X_train, y_train)
            y_pred = mlp.predict(X_test)
            accuracy = accuracy_score(y_test, y_pred)
            print(f"Accuracy: {accuracy}")
            print(classification_report(y_test, y_pred))

            if accuracy > best_accuracy:
                best_accuracy = accuracy
                best_model = mlp

    print(f"Best Model Accuracy: {best_accuracy}")

    # Save the best model (optional)
    if best_model:
        from joblib import dump
        dump(best_model, "best_mlp_model.joblib")

if __name__ == "__main__":
    main()
